{% extends "base.html" %}

{% block title %}Registrar Rutina{% endblock %}
{% block style %}../static/css/registrarRutina.css{% endblock style %}

{% block body %}

<main class="main">
    <div class="form-container">
        <h3 class="form-container__title">Agregar rutina</h3>
        <form class="form" action="{% url 'registrarRutina' %}" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form__row">
                <div class="container__image">
                    <img src="https://www.shutterstock.com/image-vector/default-ui-image-placeholder-wireframes-600nw-1037719192.jpg" alt="" class="form__image" id="imagePreview">
                </div>
                <input type="file" id="file-input" name="txtImagen" class="form__file-input" onchange="previewImage(event)" accept=".jpg, .jpeg, .png">
                <label for="file-input" class="form__file-label">
                    Sube una imagen para la rutina (formatos aceptados: JPG, PNG)
                </label>
            </div>
            <div class="form__field">
                <label for="txtCliente" class="form__label">Cliente</label>
                <div class="form__input-group">
                    <input type="text" id="txtCliente" name="txtCliente" class="form__input" placeholder="Seleccionar cliente" readonly required>
                    <button type="button" class="form__button--popup" onclick="openClientSelection()">Seleccionar</button>
                </div>
            </div>
            <div class="form__row">
                <div class="form__field">
                    <label for="txtNombre" class="form__label">Nombre</label>
                    <input type="text" id="txtNombre" name="txtNombre" class="form__input" placeholder="Ingresar nuevo nombre" maxlength="255" required>
                </div>
                <div class="form__field">
                    <label for="txtDescripcion" class="form__label">Descripción</label>
                    <textarea id="txtDescripcion" name="txtDescripcion" class="form__input" placeholder="Ingresar nueva descripción" rows="3" required></textarea>
                </div>
            </div>
            <div class="form__row">
                <div class="form__field">
                    <label for="txtTipo" class="form__label">Tipo</label>
                    <select id="txtTipo" name="txtTipo" class="form__input" required>
                        {% for tipo in tipos %}
                            <option value="{{ tipo.TipoDeRutinaID }}">{{ tipo.Nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form__field">
                    <label for="txtFrecuencia" class="form__label">Frecuencia</label>
                    <select id="txtFrecuencia" name="txtFrecuencia" class="form__input" required>
                        {% for frecuencia in frecuencias %}
                            <option value="{{ frecuencia }}">{{ frecuencia }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="form__row">
                <div class="form__field">
                    <label for="txtInstructor" class="form__label">Instructor</label>
                    <select id="txtInstructor" name="txtInstructor" class="form__input" required>
                        {% for instructor in instructores %}
                            <option value="{{ instructor.InstructorID }}">{{ instructor.Nombres }} {{ instructor.Apellidos }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form__field">
                    <label for="txtFechaInicio" class="form__label">Fecha de Inicio</label>
                    <input type="date" id="txtFechaInicio" name="txtFechaInicio" class="form__input" required>
                </div>
            </div>
            <div class="form__row">
                <div class="form__field">
                    <label for="txtFechaFin" class="form__label">Fecha de Fin</label>
                    <input type="date" id="txtFechaFin" name="txtFechaFin" class="form__input" required>
                </div>
                <div class="form__field">
                    <label for="txtHorasRecomendadas" class="form__label">Horas Recomendadas</label>
                    <input type="text" id="txtHorasRecomendadas" name="txtHorasRecomendadas" class="form__input" placeholder="Horas Recomendadas" required>
                </div>
            </div>
            <div class="form__row">
                <div class="form__field">
                    <label for="txtObjetivos" class="form__label">Objetivos</label>
                    <textarea id="txtObjetivos" name="txtObjetivos" class="form__input" placeholder="Objetivos" rows="3" required></textarea>
                </div>
            </div>
            <div class="form__row">
                <div class="form__field">
                    <label for="txtBicep" class="form__label">Bíceps</label>
                    <input type="number" id="txtBicep" name="txtBicep" class="form__input" placeholder="Medida de bíceps">
                </div>
                <div class="form__field">
                    <label for="txtTricep" class="form__label">Tríceps</label>
                    <input type="number" id="txtTricep" name="txtTricep" class="form__input" placeholder="Medida de tríceps">
                </div>
            </div>
            <div class="form__row">
                <div class="form__field">
                    <label for="txtPectorales" class="form__label">Pectorales</label>
                    <input type="number" id="txtPectorales" name="txtPectorales" class="form__input" placeholder="Medida de pectorales">
                </div>
                <div class="form__field">
                    <label for="txtDorsales" class="form__label">Dorsales</label>
                    <input type="number" id="txtDorsales" name="txtDorsales" class="form__input" placeholder="Medida de dorsales">
                </div>
            </div>
            <div class="form__row">
                <div class="form__field">
                    <label for="txtCintura" class="form__label">Cintura</label>
                    <input type="number" id="txtCintura" name="txtCintura" class="form__input" placeholder="Medida de cintura">
                </div>
                <div class="form__field">
                    <label for="txtGluteos" class="form__label">Glúteos</label>
                    <input type="number" id="txtGluteos" name="txtGluteos" class="form__input" placeholder="Medida de glúteos">
                </div>
            </div>
            <div class="form__row">
                <div class="form__field">
                    <label for="txtCuello" class="form__label">Cuello</label>
                    <input type="number" id="txtCuello" name="txtCuello" class="form__input" placeholder="Medida de cuello">
                </div>
                <div class="form__field">
                    <label for="txtEstado" class="form__label">Estado</label>
                    <input type="text" id="txtEstado" name="txtEstado" class="form__input" placeholder="Estado">
                </div>
            </div>
            <div class="form__row form__row--buttons">
                <button type="button" class="form__button form__button--cancel" onclick="window.history.back();">Cancelar</button>
                <button type="submit" class="form__button form__button--submit">Agregar</button>
            </div>
        </form>
    </div>
</main>

<script>
    function previewImage(event) {
        var input = event.target;
        var reader = new FileReader();
        reader.onload = function() {
            var imagePreviewContainer = document.getElementById('imagePreview');
            imagePreviewContainer.src = reader.result;
        };
        reader.readAsDataURL(input.files[0]);
    }

    function openClientSelection() {
        let clientsHTML = '';
        {% for cliente in clientes %}
            clientsHTML += `
                <div class="client-card" onclick="selectClient('{{ cliente.ClienteID.UsuarioID }}', '{{ cliente.ClienteID.Nombre }} {{ cliente.ClienteID.Apellido }}')">
                    <h4>{{ cliente.ClienteID.Nombre }} {{ cliente.ClienteID.Apellido }}</h4>
                    <p>Talla: {{ cliente.Talla }}</p>
                    <p>Peso: {{ cliente.PorcentajeGrasaCorporal }}</p>
                    <p>Nivel: {{ cliente.NivelCondicionFisica }}</p>
                    <p>Objetivo: {{ cliente.ObjetivoPrincipal }}</p>
                </div>
            `;
        {% endfor %}

        Swal.fire({
            title: 'Seleccionar Cliente',
            html: `<div style="max-height: 300px; overflow-y: auto;">${clientsHTML}</div>`,
            width: 600,
            showCancelButton: true,
            confirmButtonText: 'Aceptar',
            cancelButtonText: 'Cancelar',
            preConfirm: () => {
                const selectedClientId = document.querySelector('input[name="selectedClientId"]');
                if (!selectedClientId) {
                    Swal.showValidationMessage('Debes seleccionar un cliente');
                }
                return selectedClientId ? selectedClientId.value : null;
            }
        });
    }

    function selectClient(clientId, clientName) {
        console.log(clientId)
        console.log(clientName)
        Swal.fire({
            title: 'Confirmar selección',
            text: `¿Está seguro que desea seleccionar al cliente ${clientName}?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Aceptar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('txtCliente').value = clientName;
                document.getElementById('txtCliente').dataset.clientId = clientId;
                Swal.close(); // Cierra el alert de selección de cliente
            }
        });
    }

    document.querySelector('form').addEventListener('submit', function(e) {
        const clientId = document.getElementById('txtCliente').dataset.clientId;
        if (!clientId) {
            e.preventDefault();
            Swal.fire('Error', 'Debes seleccionar un cliente antes de enviar el formulario', 'error');
        } else {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'txtCliente';
            input.value = clientId;
            this.appendChild(input);
        }
    });

    document.getElementById('txtInstructor').addEventListener('change', function() {
        const instructorId = this.value;
        const frecuenciaField = document.getElementById('txtFrecuencia');
        
        fetch(`/getFrecuencia/${instructorId}/`)
            .then(response => response.json())
            .then(data => {
                frecuenciaField.value = data.frecuencia || 'No disponible';
            });
    });
</script>
{% endblock %}
