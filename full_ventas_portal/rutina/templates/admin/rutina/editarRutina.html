{% extends "base.html" %}
{% load static %}

{% block title %} Editar Rutina {% endblock title %}

{% block extra_styles %}
    <link rel="stylesheet" href="{% static 'css/formularioRutina.css' %}">
    <link rel="stylesheet" href="{% static 'css/navbar.css' %}">
{% endblock extra_styles %}

{% block body %}
{% include "admin/navbar.html" %}
<main class="main">
    <div class="content">
        <div class="form-container">
            <h3 class="form-container__title">Editar rutina</h3>
            <form class="form" action="{% url 'editarRutina' rutina.RutinaID %}" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form__row">
                    <div class="container__image">
                        {% if rutina.Imagen1 %}
                            <img src="{{ rutina.Imagen1.url }}" alt="Imagen de rutina" class="form__image" id="imagePreview1">
                        {% else %}
                            <img src="https://www.shutterstock.com/image-vector/default-ui-image-placeholder-wireframes-600nw-1037719192.jpg" alt="Imagen 1" class="form__image" id="imagePreview1">
                        {% endif %}
                        <button type="button" class="remove__image" onclick="removeImage('imagePreview1', 'file-input1', 'EliminarImagen1')">X</button>
                        <input type="hidden" name="EliminarImagen1" value="false" id="EliminarImagen1">
                    </div>
                    <input type="file" id="file-input1" name="Imagen1" class="form__file-input" onchange="previewImage(event, 'imagePreview1', 'EliminarImagen1')" accept=".jpg, .jpeg, .png">
                    <label for="file-input1" class="form__file-label">
                        Sube una imagen para la rutina (formatos aceptados: JPG, PNG)
                    </label>
                
                    <div class="container__image">
                        {% if rutina.Imagen2 %}
                            <img src="{{ rutina.Imagen2.url }}" alt="Imagen de rutina" class="form__image" id="imagePreview2">
                        {% else %}
                            <img src="https://www.shutterstock.com/image-vector/default-ui-image-placeholder-wireframes-600nw-1037719192.jpg" alt="Imagen 2" class="form__image" id="imagePreview2">
                        {% endif %}
                        <button type="button" class="remove__image" onclick="removeImage('imagePreview2', 'file-input2', 'EliminarImagen2')">X</button>
                        <input type="hidden" name="EliminarImagen2" value="false" id="EliminarImagen2">
                    </div>
                    <input type="file" id="file-input2" name="Imagen2" class="form__file-input" onchange="previewImage(event, 'imagePreview2', 'EliminarImagen2')" accept=".jpg, .jpeg, .png">
                    <label for="file-input2" class="form__file-label">
                        Sube una imagen para la rutina (formatos aceptados: JPG, PNG)
                    </label>
                </div>
                
                <div class="form__row">
                    <div class="form__field">
                        <label for="TipoID" class="form__label">Tipo</label>
                        <select id="TipoID" name="TipoID" class="form__input" required>
                            {% for tipo in tipos %}
                                <option value="{{ tipo.TipoDeRutinaID }}" {% if tipo.TipoDeRutinaID == rutina.TipoID_id %}selected{% endif %}>{{ tipo.Nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form__field">
                        <label for="InstructorID" class="form__label">Instructor</label>
                        <select id="InstructorID" name="InstructorID" class="form__input" required>
                            {% for instructor in instructores %}
                                <option value="{{ instructor.InstructorID }}" {% if instructor.InstructorID == rutina.InstructorID_id %}selected{% endif %}>{{ instructor.Nombres }} {{ instructor.Apellidos }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form__field">
                        <label for="Frecuencia" class="form__label">Frecuencia</label>
                        <input type="text" id="Frecuenca" name="Frecuencia" class="form__input" value="{{ rutina.Frecuencia }}" placeholder="Ingresar la frecuencia" maxlength="50" required>
                    </div>
                </div>
                <div class="form__row">
                    <div class="form__field">
                        <label for="FechaInicio" class="form__label">Fecha de Inicio</label>
                        <input type="date" id="FechaInicio" name="FechaInicio" class="form__input" required value="{{ rutina.FechaInicio|date:"Y-m-d" }}">
                    </div>
                    <div class="form__field">
                        <label for="FechaFin" class="form__label">Fecha de Fin</label>
                        <input type="date" id="FechaFin" name="FechaFin" class="form__input" required value="{{ rutina.FechaFin|date:"Y-m-d" }}">
                    </div>
                </div>
                <div class="form__row">
                    <div class="form__field">
                        <label for="ClienteID" class="form__label">Cliente</label>
                        <div class="form__input-group">
                            <input type="text" id="ClienteID" name="ClienteID" class="form__input" placeholder="Seleccionar cliente" readonly required value="{{ rutina.ClienteID.ClienteID.Nombre }} {{ rutina.ClienteID.ClienteID.Apellido }}" data-client-id="{{ rutina.ClienteID.ClienteID.UsuarioID }}">
                            <button type="button" class="form__button--popup" onclick="openClientSelection()">Seleccionar</button>
                        </div>
                    </div>
                </div>
                <div class="form__row--description">
                    <div class="form__field">
                        <label for="Nombre" class="form__label">Nombre</label>
                        <input type="text" id="Nombre" name="Nombre" class="form__input" placeholder="Ingresar nombre" maxlength="255" required value="{{ rutina.Nombre }}">
                    </div>
                    <div class="form__field">
                        <label for="Descripcion" class="form__label">Descripción</label>
                        <textarea id="Descripcion" name="Descripcion" class="form__input" placeholder="Ingresar descripción" rows="3">{{ rutina.Descripcion }}</textarea>
                    </div>
                </div>
                <div class="form__row">
                    <div class="form__field">
                        <label for="Objetivos" class="form__label">Objetivos</label>
                        <textarea name="Objetivos" id="Objetivos" class="form__input" placeholder="Ingresar objetivos de la rutina"  required rows="4">{{ rutina.Objetivos }}</textarea>
                    </div>
                </div>
                <div class="form__field" id="objectives-container">
                    <label class="form__label">Metas</label>
                    <div class="form__input-group-objectives">
                        <p>¿Qué es lo que quieres reducir o aumentar?</p>
                        <button type="button" class="form__button--popup" onclick="addObjective()" id="buttonAddObjective">Agregar Meta</button>
                    </div>
                    {% for meta in metas %}
                        <div class="form__input-group">
                            <div class="form__field">
                                <input type="text" name="MetaNombre{{ forloop.counter0 }}" class="form__input" placeholder="Nombre de la meta" required value="{{ meta.Nombre }}">
                            </div>
                            <div class="form__field">
                                <input type="text" name="MetaEstadoInicial{{ forloop.counter0 }}" step="0.01" class="form__input" placeholder="Estado inicial" required value="{{ meta.EstadoInicial }}">
                            </div>
                            <div class="form__field">
                                <input type="text" name="MetaEstadoFinal{{ forloop.counter0 }}" step="0.01" class="form__input" placeholder="Estado final" required value="{{ meta.EstadoFinal }}">
                            </div>
                            <button type="button" class="form__button--remove-objective" onclick="removeObjective(this)">
                                <span class="iconify" data-icon="mdi:trash-can" data-inline="false"></span>
                            </button>
                        </div>
                    {% endfor %}
                </div>
                <div class="form__row form__row--buttons">
                    <button type="button" class="form__button form__button--cancel" onclick="window.history.back();">Cancelar</button>
                    <button type="submit" class="form__button form__button--submit">Actualizar</button>
                </div>
            </form>
        </div>
    </div>
</main>
<script>
    let objectiveCount = {{ metas|length }};

    function previewImage(event, previewId, hiddenInputId) {
        const fileInput = event.target;
        const imagePreview = document.getElementById(previewId);
        const hiddenInput = document.getElementById(hiddenInputId);
        
        if (fileInput.files && fileInput.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function (e) {
                imagePreview.src = e.target.result;
                hiddenInput.value = 'false';
            }
            
            reader.readAsDataURL(fileInput.files[0]);
        }
    }
    
    function removeImage(previewId, fileInputId, hiddenInputId) {
        const imagePreview = document.getElementById(previewId);
        const fileInput = document.getElementById(fileInputId);
        const hiddenInput = document.getElementById(hiddenInputId);
    
        fileInput.value = '';  // Limpiar el input de archivo
        hiddenInput.value = 'true';  // Indicar que la imagen ha sido eliminada
    
        imagePreview.src = 'https://www.shutterstock.com/image-vector/default-ui-image-placeholder-wireframes-600nw-1037719192.jpg';
    }

    function openClientSelection() {
        let clientsHTML = '';
        {% for cliente in clientes %}
            clientsHTML += `
                <div class="client-card" onclick="selectClient('{{ cliente.ClienteID.UsuarioID }}', '{{ cliente.ClienteID.Nombre }} {{ cliente.ClienteID.Apellido }}')">
                    <h4>{{ cliente.ClienteID.Nombre }} {{ cliente.ClienteID.Apellido }}</h4>
                    <p>Talla: {{ cliente.Talla }}</p>
                    <p>Peso: {{ cliente.PorcentajeGrasaCorporal }}</p>
                    <p>Nivel: {{ cliente.NivelCondicionFisica }}</p>
                    <p>Objetivo: {{ cliente.ObjetivoPrincipal }}</p>
                </div>
            `;
        {% endfor %}

        Swal.fire({
            title: 'Seleccionar Cliente',
            html: `<div style="max-height: 300px; overflow-y: auto;">${clientsHTML}</div>`,
            width: 600,
            showCancelButton: true,
            confirmButtonText: 'Aceptar',
            cancelButtonText: 'Cancelar'
        });
    }

    function selectClient(clientId, clientName) {
        document.getElementById('ClienteID').value = clientName;
        document.getElementById('ClienteID').dataset.clientId = clientId;
        Swal.close();
    }

    function addObjective() {
        const container = document.getElementById('objectives-container');
        const newRow = document.createElement('div');
        newRow.className = 'form__input-group';
        newRow.innerHTML = `
            <div class="form__field">
                <input type="text" name="MetaNombre${objectiveCount}" id="MetaNombre${objectiveCount}" class="form__input" placeholder="Nombre de la meta" required>
            </div>
            <div class="form__field">
                <input type="number" name="MetaEstadoInicial${objectiveCount}" id="EstadoInicial${objectiveCount}" step="0.01" class="form__input" placeholder="Estado inicial" required>
            </div>
            <div class="form__field">
                <input type="number" name="MetaEstadoFinal${objectiveCount}" id="EstadoFinal${objectiveCount}" step="0.01" class="form__input" placeholder="Estado final" required>
            </div>
            <button type="button" class="form__button--remove-objective" onclick="removeObjective(this)">
                <span class="iconify" data-icon="mdi:trash-can" data-inline="false"></span>
            </button>
        `;
        container.appendChild(newRow);
        objectiveCount++;
    }

    function removeObjective(button) {
        button.parentElement.remove();
    }

    document.querySelector('form').addEventListener('submit', function(e) {
        const clientId = document.getElementById('ClienteID').dataset.clientId;

        console.log(clientId);
        
        if (!clientId) {
            e.preventDefault();
            Swal.fire('Error', 'Debes seleccionar un cliente antes de enviar el formulario', 'error');
        } else {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'ClienteID';
            input.value = clientId;
            this.appendChild(input);
        }
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {

        const tipoRutinaSelect = document.getElementById('TipoID');
        const instructorSelect = document.getElementById('InstructorID');
        const frecuenciaSelect = document.getElementById('Frecuencia');

        const fechaInicioInput = document.getElementById('FechaInicio');
        const fechaFinInput = document.getElementById('FechaFin');

        const today = new Date().toISOString().split('T')[0];

        fechaInicioInput.setAttribute('min', today);
        fechaFinInput.setAttribute('min', today);

        tipoRutinaSelect.addEventListener('change', function () {
            const tipoRutinaID = this.value;
            objectiveCount = 0;

            if (tipoRutinaID) {
                instructorSelect.disabled = false;
                instructorSelect.innerHTML = ''; 

                const defaultOptionInstructor = document.createElement('option');
                defaultOptionInstructor.textContent = 'Seleccionar instructor';
                defaultOptionInstructor.disabled = true;
                defaultOptionInstructor.selected = true;
                defaultOptionInstructor.value = "";
                instructorSelect.appendChild(defaultOptionInstructor);

                fetch(`/obtener-instructores/?tipo_rutina_id=${tipoRutinaID}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(function (instructor) {
                            const option = document.createElement('option');
                            option.value = instructor.id;
                            option.textContent = instructor.nombre;
                            instructorSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error fetching instructors:', error));


                fetch(`/obtener_metas_por_tipo_de_rutina/?tipo_rutina_id=${tipoRutinaID}`)
                    .then(response => response.json())
                    .then(data => {
                        const container = document.getElementById('objectives-container');
                        const addObjective = document.getElementById('buttonAddObjective');
                        
                        const inputGroups = container.querySelectorAll('.form__input-group');
                        inputGroups.forEach(group => group.remove());

                        if (data.length === 0) {
                            addObjective.disabled = false;
                        } else {
                            addObjective.disabled = true;
                            data.forEach(function(meta_predeterminada) {
                                const newRow = document.createElement('div');
                                newRow.className = 'form__input-group';
                                newRow.innerHTML = `
                                    <div class="form__field">
                                        <input type="text" name="MetaNombre${objectiveCount}" id="MetaNombre${objectiveCount}" value="${meta_predeterminada.nombre}" class="form__input" placeholder="Nombre de la meta" required readonly>
                                    </div>
                                    <div class="form__field">
                                        <input type="number" name="MetaEstadoInicial${objectiveCount}" id="EstadoInicial${objectiveCount}" step="0.01" class="form__input" placeholder="Estado inicial" required>
                                    </div>
                                    <div class="form__field">
                                        <input type="number" name="MetaEstadoFinal${objectiveCount}" id="EstadoFinal${objectiveCount}" step="0.01" class="form__input" placeholder="Estado final" required>
                                    </div>
                                `;
                                container.appendChild(newRow);
                                objectiveCount++;
                            });
                        }
                    })
                    .catch(error => console.error('Error fetching metas predeterminadas', error))


            } else {
                instructorSelect.disabled = true;
            }
        });
    });
</script>
{% endblock %}
